# ----------------------------------------------------------------------
#  This file tells Docker how to run multiple containers together:
#  Postgres + KnightShift pipeline
#
#  Run it with:
#  docker compose up --build
# ----------------------------------------------------------------------

services:               # define the services (containers) to be run
  db:
    image: postgres:17 
    restart: always     # Automatic restart if it crashes or Docker restarts
    environment:        # Env variables - db info created at startup
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: knightshift
    ports:
      - "127.0.0.1:55432:5432"

    # This maps port 5432 inside Postgres container (default Postgres port) to
    # port 55432 on local machine, avoiding conflicts with local Postgres

    volumes:
      - pg_data:/var/lib/postgresql/data         # Use pg_data to persist Postgres data
      - ./schemas:/docker-entrypoint-initdb.d    # Mount schemas folder so SQL files run on first DB startup

  pipeline:
    build: .              # Build this container from local Dockerfile (current directory)
    env_file: .env.docker # Load env variables from .env.docker file
    depends_on:           # Wait for the db container to start before launching this one
      - db
    volumes:
      - ./logs:/app/logs  # Mount logs folder into the containerâ€™s /app/logs so logs persist

volumes:
  pg_data:               # Named volume to persist Postgres data even after container restarts/deletes
